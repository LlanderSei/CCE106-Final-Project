// Source code dump of all files in e:\Documents\Llander\Yuemnigga\CCE106\Project\bbqlagao_and_beefpares\lib

// customtoast.dart
import 'package:flutter/material.dart';

class Toast {
  static OverlayEntry? _currentEntry;

  static void show(
    BuildContext context,
    String message, {
    Duration duration = const Duration(seconds: 2),
  }) {
    // Remove current toast if one exists
    _currentEntry?.remove();
    _currentEntry = null;

    final overlay = Overlay.of(context);
    late OverlayEntry entry;

    entry = OverlayEntry(
      builder: (context) => _ToastWidget(
        message: message,
        duration: duration,
        onFinish: () {
          entry.remove();
          if (_currentEntry == entry) _currentEntry = null;
        },
      ),
    );

    _currentEntry = entry;
    overlay.insert(entry);
  }
}

class _ToastWidget extends StatefulWidget {
  final String message;
  final Duration duration;
  final VoidCallback onFinish;

  const _ToastWidget({
    required this.message,
    required this.duration,
    required this.onFinish,
  });

  @override
  State<_ToastWidget> createState() => _ToastWidgetState();
}

class _ToastWidgetState extends State<_ToastWidget>
    with TickerProviderStateMixin {
  late AnimationController _fadeController;
  late AnimationController _slideController;

  late Animation<double> _fadeInAnimation;
  late Animation<Offset> _slideUpAnimation;

  @override
  void initState() {
    super.initState();

    // Quick fade-in
    _fadeController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 200),
    );
    _fadeInAnimation = CurvedAnimation(
      parent: _fadeController,
      curve: Curves.easeIn,
    );

    // Slight upward motion while fading in
    _slideController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 200),
    );
    _slideUpAnimation = Tween<Offset>(
      begin: const Offset(0, 0.1),
      end: Offset.zero,
    ).animate(CurvedAnimation(parent: _slideController, curve: Curves.easeOut));

    _fadeController.forward();
    _slideController.forward();

    // Trigger slow fade-out after duration
    Future.delayed(widget.duration, () {
      if (mounted) {
        _fadeController.reverseDuration = const Duration(milliseconds: 800);
        _fadeController.reverse().whenComplete(widget.onFinish);
      }
    });
  }

  @override
  void dispose() {
    _fadeController.dispose();
    _slideController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Positioned(
      bottom: 80,
      left: MediaQuery.of(context).size.width * 0.1,
      right: MediaQuery.of(context).size.width * 0.1,
      child: Material(
        color: Colors.transparent,
        child: FadeTransition(
          opacity: _fadeInAnimation,
          child: SlideTransition(
            position: _slideUpAnimation,
            child: Center(
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 16,
                  vertical: 10,
                ),
                decoration: BoxDecoration(
                  color: Colors.black87,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  widget.message,
                  style: const TextStyle(color: Colors.white, fontSize: 14),
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}
// END OF FILE for customtoast.dart


// main.dart
// main.dart
import 'package:bbqlagao_and_beefpares/pages/manager/staff_home_page.dart';
import 'package:bbqlagao_and_beefpares/pages/cashier/cashier_home_page.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/users_controller.dart';
import 'package:bbqlagao_and_beefpares/models/user.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  await _registerFirstAdmin();
  runApp(
    ProviderScope(
      child: MaterialApp(
        initialRoute: '/cashier',
        routes: {
          // '/auth': (context) => AuthScreen(),
          '/staff': (context) => StaffHomePage(),
          '/cashier': (context) => CashierHomePage(),
        },
      ),
    ),
  );
}

Future<void> _registerFirstAdmin() async {
  final usersController = UsersController();
  final adminEmail = 'admin@admin.com';
  final query = await FirebaseFirestore.instance
      .collection('users')
      .where('email', isEqualTo: adminEmail)
      .get();
  if (query.docs.isEmpty) {
    final adminUser = User(name: 'Admin', email: adminEmail, role: 'Admin');
    await usersController.addUser(null, adminUser, 'password');
  }
}

class MainApp extends StatelessWidget {
  const MainApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Manager Home Screen',
      theme: ThemeData.from(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.redAccent),
      ),
    );
  }
}
// END OF FILE for main.dart


// controllers\general\order_controller.dart
// controllers/order_controller.dart
import 'package:cloud_firestore/cloud_firestore.dart' as fs;
import 'package:bbqlagao_and_beefpares/models/order.dart';
import 'package:bbqlagao_and_beefpares/models/dish.dart';
import 'package:bbqlagao_and_beefpares/models/item.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/menu_controller.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/inventory_controller.dart';

class OrderController {
  final fs.FirebaseFirestore _firestore = fs.FirebaseFirestore.instance;
  final String _collection = 'orders';
  final MenuController _menuController = MenuController();
  final InventoryController _inventoryController = InventoryController();

  Stream<List<Order>> getOrdersByStatus(String status) => _firestore
      .collection(_collection)
      .where('status', isEqualTo: status)
      .orderBy('createdAt', descending: true)
      .snapshots()
      .map(
        (snapshot) =>
            snapshot.docs.map((doc) => Order.fromFirestore(doc)).toList(),
      );

  Future<int> getNextOrderId() async {
    final snapshot = await _firestore
        .collection(_collection)
        .orderBy('orderId', descending: true)
        .limit(1)
        .get();
    if (snapshot.docs.isEmpty) return 1;
    return 1 + snapshot.docs.first.data()['orderId'] as int;
  }

  Future<void> addOrder(Order order) async {
    await _firestore.collection(_collection).add(order.toFirestore());
    await _deductIngredients(order);
  }

  Future<void> updateOrderStatus(
    String orderId,
    String status, {
    DateTime? timestamp,
  }) async {
    final data = {
      'status': status,
      'updatedAt': fs.Timestamp.fromDate(DateTime.now()),
    };
    if (timestamp != null) {
      if (status == 'preparing')
        data['preparedAt'] = fs.Timestamp.fromDate(timestamp);
      if (status == 'serving')
        data['servedAt'] = fs.Timestamp.fromDate(timestamp);
    }
    await _firestore.collection(_collection).doc(orderId).update(data);
  }

  Future<bool> canAffordQuantity(String dishId, int quantity) async {
    final dishSnapshot = await _firestore.collection('menu').doc(dishId).get();
    if (!dishSnapshot.exists) return false;
    final dishData = dishSnapshot.data()!;
    final ingredients = List<Map<String, dynamic>>.from(
      dishData['ingredients'] ?? [],
    );
    for (var ing in ingredients) {
      final itemId = ing['itemId'];
      final reqQty = (ing['quantity'] as int) * quantity;
      final itemSnapshot = await _firestore
          .collection('inventory')
          .doc(itemId)
          .get();
      if (!itemSnapshot.exists ||
          (itemSnapshot.data()?['quantity'] ?? 0) < reqQty) {
        return false;
      }
    }
    return true;
  }

  Future<void> _deductIngredients(Order order) async {
    for (var item in order.items) {
      final dishId = item['dishId'];
      final qty = item['quantity'] as int;
      final dishSnapshot = await _firestore
          .collection('menu')
          .doc(dishId)
          .get();
      final ingredients = List<Map<String, dynamic>>.from(
        dishSnapshot.data()?['ingredients'] ?? [],
      );
      for (var ing in ingredients) {
        final itemId = ing['itemId'];
        final deductQty = (ing['quantity'] as int) * qty;
        await _firestore.collection('inventory').doc(itemId).update({
          'quantity': fs.FieldValue.increment(-deductQty),
        });
      }
    }
  }
}
// END OF FILE for controllers\general\order_controller.dart


// controllers\general\payment_controller.dart
// controllers/payment_controller.dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:bbqlagao_and_beefpares/models/payment.dart';

class PaymentController {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final String _collection = 'payments';

  Future<void> addPayment(Payment payment) async {
    await _firestore.collection(_collection).add(payment.toFirestore());
  }

  Stream<List<Payment>> getPaymentsByOrderId(int orderId) => _firestore
      .collection(_collection)
      .where('orderId', isEqualTo: orderId)
      .snapshots()
      .map(
        (snapshot) =>
            snapshot.docs.map((doc) => Payment.fromFirestore(doc)).toList(),
      );
}
// END OF FILE for controllers\general\payment_controller.dart


// controllers\manager\inventory_controller.dart
// lib/controllers/inventory_controller.dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:bbqlagao_and_beefpares/models/item.dart';

class InventoryController {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final String _collection = 'inventory';

  Stream<List<Item>> get getItems => _firestore
      .collection(_collection)
      .snapshots()
      .map(
        (snapshot) =>
            snapshot.docs.map((doc) => Item.fromFirestore(doc)).toList(),
      );

  Future<void> addItem(Item item) async {
    await _firestore.collection(_collection).add(item.toFirestore());
  }

  Future<void> updateItem(String id, Item item) async {
    await _firestore.collection(_collection).doc(id).update(item.toFirestore());
  }

  Future<void> deleteItem(String id) async {
    await _firestore.collection(_collection).doc(id).delete();
  }
}
// END OF FILE for controllers\manager\inventory_controller.dart


// controllers\manager\menu_controller.dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:bbqlagao_and_beefpares/models/dish.dart';

class MenuController {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final String _collection = 'menu';

  Stream<List<Dish>> get getDishes => _firestore
      .collection(_collection)
      .snapshots()
      .map(
        (snapshot) =>
            snapshot.docs.map((doc) => Dish.fromFirestore(doc)).toList(),
      );

  Future<void> addDish(Dish dish) async {
    await _firestore.collection(_collection).add(dish.toFirestore());
  }

  Future<void> updateDish(String id, Dish dish) async {
    await _firestore.collection(_collection).doc(id).update(dish.toFirestore());
  }

  Future<void> deleteDish(String id) async {
    await _firestore.collection(_collection).doc(id).delete();
  }
}
// END OF FILE for controllers\manager\menu_controller.dart


// controllers\manager\users_controller.dart
import 'package:bbqlagao_and_beefpares/customtoast.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart' as auth;
import 'package:bbqlagao_and_beefpares/models/user.dart';
import 'package:flutter/material.dart';

class UsersController {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final auth.FirebaseAuth _auth = auth.FirebaseAuth.instance;
  final String _collection = 'users';

  Stream<List<User>> get getUsers => _firestore
      .collection(_collection)
      .where('role', whereIn: ['Admin', 'Manager', 'Cashier'])
      .snapshots()
      .map(
        (snapshot) =>
            snapshot.docs.map((doc) => User.fromFirestore(doc)).toList(),
      );

  Future<void> addUser(dynamic context, User user, String password) async {
    try {
      auth.UserCredential userCredential = await _auth
          .createUserWithEmailAndPassword(
            email: user.email,
            password: password,
          );
      String uid = userCredential.user!.uid;
      await _firestore.collection(_collection).doc(uid).set(user.toFirestore());
      await _firestore.collection(_collection).doc(uid).update({
        'provider': 'Email/Password',
      });
      if (context != null && (context as BuildContext).mounted) {
        Toast.show(context, 'User added successfully');
      }
    } catch (e) {
      rethrow;
    }
  }

  Future<void> updateUser(dynamic context, id, User user) async {
    await _firestore.collection(_collection).doc(id).update(user.toFirestore());
    if (context != null && (context as BuildContext).mounted) {
      Toast.show(context, 'User updated successfully');
    }
  }
}
// END OF FILE for controllers\manager\users_controller.dart


// models\dish.dart
import 'package:cloud_firestore/cloud_firestore.dart';

class Dish {
  final String? id;
  final String name;
  final String? description;
  final double price;
  final bool isVisible;
  final bool isAvailable;
  final List<Map<String, dynamic>> ingredients;
  final String? imageUrl;

  Dish({
    this.id,
    required this.name,
    this.description,
    required this.price,
    this.isVisible = true,
    this.isAvailable = true,
    required this.ingredients,
    this.imageUrl,
  });

  factory Dish.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>? ?? {};
    return Dish(
      id: doc.id,
      name: data['name'] ?? '',
      description: data['description'],
      price: (data['price'] ?? 0.0).toDouble(),
      isVisible: data['isVisible'] ?? true,
      isAvailable: data['isAvailable'] ?? true,
      ingredients: List<Map<String, dynamic>>.from(data['ingredients'] ?? []),
      imageUrl: data['imageUrl'],
    );
  }

  Map<String, dynamic> toFirestore() {
    return {
      'name': name,
      if (description != null) 'description': description,
      'price': price,
      'isVisible': isVisible,
      'isAvailable': isAvailable,
      'ingredients': ingredients,
      if (imageUrl != null) 'imageUrl': imageUrl,
    };
  }
}
// END OF FILE for models\dish.dart


// models\item.dart
import 'package:cloud_firestore/cloud_firestore.dart';

class Item {
  final String? id;
  final String name;
  final String? description;
  final int quantity;
  final String? imageUrl;

  Item({
    this.id,
    required this.name,
    this.description,
    required this.quantity,
    this.imageUrl,
  });

  factory Item.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>? ?? {};
    return Item(
      id: doc.id,
      name: data['name'] ?? '',
      description: data['description'],
      quantity: data['quantity'] ?? 0,
      imageUrl: data['imageUrl'],
    );
  }

  Map<String, dynamic> toFirestore() {
    return {
      'name': name,
      if (description != null) 'description': description,
      'quantity': quantity,
      if (imageUrl != null) 'imageUrl': imageUrl,
    };
  }
}
// END OF FILE for models\item.dart


// models\order.dart
// models/order.dart
import 'package:cloud_firestore/cloud_firestore.dart';

class Order {
  final String? id;
  final int orderId;
  final String? userId;
  final String name;
  final List<Map<String, dynamic>> items;
  final String status;
  final double totalAmount;
  final String orderType;
  final DateTime createdAt;
  final DateTime? preparedAt;
  final DateTime? servedAt;
  final DateTime updatedAt;

  Order({
    this.id,
    required this.orderId,
    this.userId,
    required this.name,
    required this.items,
    this.status = 'reviewing',
    required this.totalAmount,
    this.orderType = 'dine-in',
    required this.createdAt,
    this.preparedAt,
    this.servedAt,
    required this.updatedAt,
  });

  factory Order.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>? ?? {};
    return Order(
      id: doc.id,
      orderId: data['orderId'] ?? 0,
      userId: data['userId'],
      name: data['name'] ?? '',
      items: List<Map<String, dynamic>>.from(data['items'] ?? []),
      status: data['status'] ?? 'reviewing',
      totalAmount: (data['totalAmount'] ?? 0.0).toDouble(),
      orderType: data['orderType'] ?? 'dine-in',
      createdAt: (data['createdAt'] as Timestamp?)?.toDate() ?? DateTime.now(),
      preparedAt: (data['preparedAt'] as Timestamp?)?.toDate(),
      servedAt: (data['servedAt'] as Timestamp?)?.toDate(),
      updatedAt: (data['updatedAt'] as Timestamp?)?.toDate() ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toFirestore() {
    return {
      'orderId': orderId,
      if (userId != null) 'userId': userId,
      'name': name,
      'items': items,
      'status': status,
      'totalAmount': totalAmount,
      'orderType': orderType,
      'createdAt': Timestamp.fromDate(createdAt),
      if (preparedAt != null) 'preparedAt': Timestamp.fromDate(preparedAt!),
      if (servedAt != null) 'servedAt': Timestamp.fromDate(servedAt!),
      'updatedAt': Timestamp.fromDate(updatedAt),
    };
  }
}
// END OF FILE for models\order.dart


// models\payment.dart
// models/payment.dart
import 'package:cloud_firestore/cloud_firestore.dart';

class Payment {
  final String? id;
  final int orderId;
  final String paymentMethod;
  final Map<String, dynamic> paymentDetails;

  Payment({
    this.id,
    required this.orderId,
    required this.paymentMethod,
    required this.paymentDetails,
  });

  factory Payment.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>? ?? {};
    return Payment(
      id: doc.id,
      orderId: data['orderId'] ?? 0,
      paymentMethod: data['paymentMethod'] ?? '',
      paymentDetails: Map<String, dynamic>.from(data['paymentDetails'] ?? {}),
    );
  }

  Map<String, dynamic> toFirestore() {
    return {
      'orderId': orderId,
      'paymentMethod': paymentMethod,
      'paymentDetails': paymentDetails,
    };
  }
}
// END OF FILE for models\payment.dart


// models\user.dart
import 'package:cloud_firestore/cloud_firestore.dart';

class User {
  final String? id;
  final String name;
  final String email;
  final String role;
  final String? provider;

  User({
    this.id,
    required this.name,
    required this.email,
    required this.role,
    this.provider,
  });

  factory User.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>? ?? {};
    return User(
      id: doc.id,
      name: data['name'] ?? '',
      email: data['email'] ?? '',
      role: data['role'] ?? '',
      provider: data['provider'],
    );
  }

  Map<String, dynamic> toFirestore() {
    return {
      'name': name,
      'email': email,
      'role': role,
      if (provider != null) 'provider': provider,
    };
  }
}
// END OF FILE for models\user.dart


// pages\cashier\cashier_home_page.dart
// pages/cashier/cashier_home_page.dart
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/pages/cashier/orders_page.dart';
import 'package:bbqlagao_and_beefpares/pages/cashier/order_history_page.dart';

class CashierHomePage extends StatefulWidget {
  const CashierHomePage({super.key});

  @override
  State<CashierHomePage> createState() => _CashierHomePageState();
}

class _CashierHomePageState extends State<CashierHomePage> {
  String _currentPage = 'orders';
  String _appBarTitle = 'Cashier Dashboard';
  late ValueNotifier<bool> _showFabNotifier;

  void _onFabVisibilityChanged(bool visible) {
    _showFabNotifier.value = visible;
  }

  @override
  void initState() {
    super.initState();
    _showFabNotifier = ValueNotifier<bool>(true);
  }

  @override
  void dispose() {
    _showFabNotifier.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(_appBarTitle, style: TextStyle(color: Colors.white)),
        flexibleSpace: Container(
          decoration: const BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [Colors.redAccent, Colors.red, Colors.orangeAccent],
            ),
          ),
        ),
        leading: Builder(
          builder: (context) => IconButton(
            icon: const Icon(Icons.menu, color: Colors.white),
            onPressed: () => Scaffold.of(context).openDrawer(),
          ),
        ),
      ),
      drawer: Drawer(
        child: Column(
          children: [
            Container(
              height: 75.0,
              width: double.infinity,
              decoration: const BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [Colors.redAccent, Colors.red, Colors.orangeAccent],
                ),
              ),
              child: const Padding(
                padding: EdgeInsets.all(2),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.end,
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    Text(
                      'BBQ Lagao & Beef Pares',
                      style: TextStyle(color: Colors.white, fontSize: 10),
                    ),
                    Text(
                      'Staff Navigation',
                      style: TextStyle(color: Colors.white, fontSize: 20),
                    ),
                  ],
                ),
              ),
            ),
            Expanded(
              child: ListView(
                padding: EdgeInsets.zero,
                children: <Widget>[
                  ListTile(
                    leading: Icon(
                      Icons.list_alt,
                      color: _currentPage == 'orders'
                          ? Colors.white
                          : Colors.redAccent,
                    ),
                    title: Text(
                      'Orders',
                      style: TextStyle(
                        color: _currentPage == 'orders'
                            ? Colors.white
                            : Colors.redAccent,
                      ),
                    ),
                    selected: _currentPage == 'orders',
                    selectedTileColor: Colors.redAccent.withValues(alpha: .75),
                    onTap: () {
                      Navigator.pop(context);
                      setState(() {
                        _currentPage = 'orders';
                        _appBarTitle = 'Orders';
                      });
                    },
                  ),
                  ListTile(
                    leading: Icon(
                      Icons.history,
                      color: _currentPage == 'orderHistory'
                          ? Colors.white
                          : Colors.redAccent,
                    ),
                    title: Text(
                      'Order History',
                      style: TextStyle(
                        color: _currentPage == 'orderHistory'
                            ? Colors.white
                            : Colors.redAccent,
                      ),
                    ),
                    selected: _currentPage == 'orderHistory',
                    selectedTileColor: Colors.redAccent.withOpacity(0.75),
                    onTap: () {
                      Navigator.pop(context);
                      setState(() {
                        _currentPage = 'orderHistory';
                        _appBarTitle = 'Order History';
                      });
                    },
                  ),
                ],
              ),
            ),
            Align(
              alignment: Alignment.bottomRight,
              child: Padding(
                padding: const EdgeInsets.all(16.0),
                child: IconButton(
                  icon: const Icon(Icons.arrow_left),
                  onPressed: () => Navigator.pop(context),
                  tooltip: 'Close menu',
                ),
              ),
            ),
          ],
        ),
      ),
      body: _buildBody(),
    );
  }

  Widget _buildBody() {
    switch (_currentPage) {
      case 'orders':
        return OrdersPage(onFabVisibilityChanged: _onFabVisibilityChanged);
      case 'orderHistory':
        return const OrderHistoryPage();
      default:
        return const Center(child: Text('Page not implemented'));
    }
  }
}
// END OF FILE for pages\cashier\cashier_home_page.dart


// pages\cashier\new_order_page.dart
// pages/cashier/new_order_page.dart
import 'package:flutter/material.dart' hide MenuController;
import 'package:bbqlagao_and_beefpares/controllers/general/order_controller.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/menu_controller.dart';
import 'package:bbqlagao_and_beefpares/models/order.dart';
import 'package:bbqlagao_and_beefpares/models/dish.dart';
import 'package:bbqlagao_and_beefpares/customtoast.dart';
import 'payment_page.dart';

class NewOrderPage extends StatefulWidget {
  const NewOrderPage({super.key});

  @override
  State<NewOrderPage> createState() => _NewOrderPageState();
}

class _NewOrderPageState extends State<NewOrderPage> {
  final OrderController _orderController = OrderController();
  final MenuController _menuController = MenuController();
  final _formKey = GlobalKey<FormState>();
  List<Map<String, dynamic>> _selectedDishes = [];
  bool _toPrepare = false;
  bool _isPaymentEnabled = true;
  double _totalAmount = 0.0;
  final String _cashierName = 'Temporary Cashier';

  @override
  void initState() {
    super.initState();
    _calculateTotal();
  }

  void _addDish() {
    showDialog(
      context: context,
      builder: (context) => _DishSelectionDialog(
        menuController: _menuController,
        selectedDishes: _selectedDishes,
        onSelected: (dishId, dishName, price) {
          setState(() {
            _selectedDishes.add({
              'dishId': dishId,
              'name': dishName,
              'price': price,
              'quantity': 1,
              'totalPrice': price,
              'warning': false,
            });
          });
          _checkAffordability();
          _calculateTotal();
        },
      ),
    );
  }

  void _updateQuantity(String dishId, int newQty) {
    final index = _selectedDishes.indexWhere((d) => d['dishId'] == dishId);
    if (index != -1 && newQty >= 1) {
      setState(() {
        _selectedDishes[index]['quantity'] = newQty;
        _selectedDishes[index]['totalPrice'] = _selectedDishes[index]['price'] * newQty;
      });
      _checkAffordabilityForDish(dishId);
      _calculateTotal();
    }
  }

  void _removeDish(String dishId) {
    setState(() {
      _selectedDishes.removeWhere((d) => d['dishId'] == dishId);
    });
    _checkAffordability();
    _calculateTotal();
  }

  Future<void> _checkAffordability() async {
    bool allAffordable = true;
    for (var dish in _selectedDishes) {
      final affordable = await _orderController.canAffordQuantity(dish['dishId'], dish['quantity']);
      final index = _selectedDishes.indexWhere((d) => d['dishId'] == dish['dishId']);
      if (index != -1) {
        setState(() {
          _selectedDishes[index]['warning'] = !affordable;
        });
      }
      if (!affordable) allAffordable = false;
    }
    setState(() {
      _isPaymentEnabled = allAffordable && _selectedDishes.isNotEmpty;
    });
  }

  Future<void> _checkAffordabilityForDish(String dishId) async {
    final index = _selectedDishes.indexWhere((d) => d['dishId'] == dishId);
    if (index != -1) {
      final affordable = await _orderController.canAffordQuantity(dishId, _selectedDishes[index]['quantity']);
      setState(() {
        _selectedDishes[index]['warning'] = !affordable;
      });
    }
    await _checkAffordability();
  }

  void _calculateTotal() {
    _totalAmount = _selectedDishes.fold(0.0, (sum, d) => sum + (d['totalPrice'] as double));
    setState(() {});
  }

  Future<void> _proceedToPayment() async {
    if (!_isPaymentEnabled) {
      Toast.show(context, 'Cannot proceed: Insufficient ingredients for some items.');
      return;
    }
    final nextOrderId = await _orderController.getNextOrderId();
    final now = DateTime.now();
    final order = Order(
      orderId: nextOrderId,
      name: _cashierName,
      items: _selectedDishes.map((d) => {
        'dishId': d['dishId'],
        'quantity': d['quantity'],
      }).toList(),
      status: _toPrepare ? 'preparing' : 'reviewing',
      totalAmount: _totalAmount,
      createdAt: now,
      updatedAt: now,
      preparedAt: _toPrepare ? now : null,
    );
    final result = await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => PaymentPage(
          order: order,
          totalAmount: _totalAmount,
        ),
      ),
    );
    if (result == true) {
      await _orderController.addOrder(order);
      Navigator.pop(context);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('New Order'),
        backgroundColor: Colors.redAccent,
      ),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('Order Initiated By', style: Theme.of(context).textTheme.titleLarge),
                Text('$_cashierName (Cashier)', style: Theme.of(context).textTheme.bodyMedium),
              ],
            ),
          ),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton(
              onPressed: _addDish,
              style: ElevatedButton.styleFrom(backgroundColor: Colors.orangeAccent),
              child: const Text('Add Dish', style: TextStyle(color: Colors.white)),
            ),
          ),
          Expanded(
            child: ListView.builder(
              itemCount: _selectedDishes.length,
              itemBuilder: (context, index) {
                final dish = _selectedDishes[index];
                return Card(
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [Colors.red[50]!, Colors.orange[50]!],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                    ),
                    child: ListTile(
                      title: Text(dish['name']),
                      subtitle: Text(
                        '${dish['price']} | ${dish['totalPrice']}',
                        style: TextStyle(color: dish['warning'] ? Colors.red : null),
                      ),
                      trailing: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          IconButton(
                            icon: const Icon(Icons.remove),
                            onPressed: () => _updateQuantity(dish['dishId'], dish['quantity'] - 1),
                          ),
                          Text('${dish['quantity']}'),
                          IconButton(
                            icon: const Icon(Icons.add),
                            onPressed: () => _updateQuantity(dish['dishId'], dish['quantity'] + 1),
                          ),
                          IconButton(
                            icon: const Icon(Icons.delete, color: Colors.red),
                            onPressed: () => _removeDish(dish['dishId']),
                          ),
                        ],
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
          Container(
            padding: const EdgeInsets.all(16.0),
            decoration: BoxDecoration(
              color: Colors.grey[200],
              boxShadow: [BoxShadow(blurRadius: 4, color: Colors.black26, offset: Offset(0, -2))],
            ),
            child: Column(
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Row(
                      children: [
                        Text('To Prepare'),
                        Switch(
                          value: _toPrepare,
                          onChanged: (value) => setState(() => _toPrepare = value),
                        ),
                      ],
                    ),
                    Text('Total Amount: $_totalAmount'),
                  ],
                ),
                Row(
                  mainAxisAlignment: MainAxisAlignment.end,
                  children: [
                    TextButton(
                      onPressed: () => Navigator.pop(context),
                      child: const Text('Cancel'),
                    ),
                    ElevatedButton(
                      onPressed: _isPaymentEnabled ? _proceedToPayment : null,
                      style: ElevatedButton.styleFrom(backgroundColor: Colors.orangeAccent),
                      child: const Text('To Payment', style: TextStyle(color: Colors.white)),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _DishSelectionDialog extends StatefulWidget {
  final MenuController menuController;
  final List<Map<String, dynamic>> selectedDishes;
  final Function(String, String, double) onSelected;

  const _DishSelectionDialog({
    required this.menuController,
    required this.selectedDishes,
    required this.onSelected,
  });

  @override
  State<_DishSelectionDialog> createState() => _DishSelectionDialogState();
}

class _DishSelectionDialogState extends State<_DishSelectionDialog> {
  final _searchController = TextEditingController();
  String _searchText = '';
  Dish? _selectedDish;

  @override
  void initState() {
    super.initState();
    _searchController.addListener(() {
      setState(() {
        _searchText = _searchController.text.toLowerCase();
      });
    });
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('Select Dish'),
      content: SizedBox(
        width: double.maxFinite,
        height: 300,
        child: Column(
          children: [
            TextField(
              controller: _searchController,
              decoration: const InputDecoration(
                labelText: 'Search Dishes',
                prefixIcon: Icon(Icons.search),
              ),
            ),
            Expanded(
              child: StreamBuilder<List<Dish>>(
                stream: widget.menuController.getDishes,
                builder: (context, snapshot) {
                  if (snapshot.hasData) {
                    final dishes = snapshot.data!
                        .where((dish) =>
                            dish.isVisible &&
                            dish.isAvailable &&
                            dish.name.toLowerCase().contains(_searchText))
                        .toList();
                    return ListView.builder(
                      itemCount: dishes.length,
                      itemBuilder: (context, index) {
                        final dish = dishes[index];
                        final alreadyAdded = widget.selectedDishes.any((d) => d['dishId'] == dish.id);
                        return ListTile(
                          title: Text(dish.name),
                          subtitle: Text('â‚±${dish.price}'),
                          enabled: !alreadyAdded,
                          onTap: alreadyAdded ? null : () => setState(() => _selectedDish = dish),
                          selected: _selectedDish?.id == dish.id,
                        );
                      },
                    );
                  }
                  return const CircularProgressIndicator();
                },
              ),
            ),
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('Cancel'),
        ),
        ElevatedButton(
          onPressed: _selectedDish == null
              ? null
              : () {
                  widget.onSelected(_selectedDish!.id!, _selectedDish!.name, _selectedDish!.price);
                  Navigator.pop(context);
                },
          child: const Text('Add'),
        ),
      ],
    );
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
}// END OF FILE for pages\cashier\new_order_page.dart


// pages\cashier\orders_page.dart
// pages/cashier/orders_page.dart
import 'package:bbqlagao_and_beefpares/customtoast.dart';
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/pages/cashier/order_tab_page.dart';
import 'package:bbqlagao_and_beefpares/pages/cashier/preparing_tab_page.dart';
import 'package:bbqlagao_and_beefpares/pages/cashier/serving_tab_page.dart';
import 'package:bbqlagao_and_beefpares/pages/cashier/new_order_page.dart';

class OrdersPage extends StatefulWidget {
  final Function(bool)? onFabVisibilityChanged;

  const OrdersPage({super.key, this.onFabVisibilityChanged});

  @override
  State<OrdersPage> createState() => _OrdersPageState();
}

class _OrdersPageState extends State<OrdersPage> {
  int _currentIndex = 0;
  late final List<Widget> _tabs;

  @override
  void initState() {
    super.initState();
    _tabs = [
      OrderTabPage(onFabVisibilityChanged: widget.onFabVisibilityChanged),
      const PreparingTabPage(),
      const ServingTabPage(),
    ];
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: _tabs[_currentIndex],
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _currentIndex,
        onTap: (index) => setState(() => _currentIndex = index),
        items: const [
          BottomNavigationBarItem(icon: Icon(Icons.list_alt), label: 'Orders'),
          BottomNavigationBarItem(
            icon: Icon(Icons.schedule),
            label: 'Preparing',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.room_service),
            label: 'Serving',
          ),
        ],
        type: BottomNavigationBarType.fixed,
        selectedItemColor: Colors.redAccent,
        unselectedItemColor: Colors.grey,
      ),
      floatingActionButton: _currentIndex == 0
          ? FloatingActionButton(
              backgroundColor: Colors.redAccent[100],
              foregroundColor: Colors.white,
              shape: CircleBorder(),
              tooltip: 'Add New Order',
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (context) => const NewOrderPage()),
                );
              },
              child: const Icon(Icons.add),
            )
          : null,
    );
  }
}
// END OF FILE for pages\cashier\orders_page.dart


// pages\cashier\order_history_page.dart
// pages/cashier/order_history_page.dart
import 'package:flutter/material.dart';

class OrderHistoryPage extends StatelessWidget {
  const OrderHistoryPage({super.key});

  @override
  Widget build(BuildContext context) {
    return const Scaffold(body: Center(child: Text('Order History Content')));
  }
}
// END OF FILE for pages\cashier\order_history_page.dart


// pages\cashier\order_tab_page.dart
// pages/cashier/order_tab_page.dart
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/controllers/general/order_controller.dart';
import 'package:bbqlagao_and_beefpares/models/order.dart';
import 'package:bbqlagao_and_beefpares/customtoast.dart';
import 'package:flutter/rendering.dart';

class OrderTabPage extends StatefulWidget {
  final Function(bool)? onFabVisibilityChanged;

  const OrderTabPage({super.key, this.onFabVisibilityChanged});

  @override
  State<OrderTabPage> createState() => _OrderTabPageState();
}

class _OrderTabPageState extends State<OrderTabPage> {
  final ScrollController _scrollController = ScrollController();
  final OrderController _controller = OrderController();

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_scrollListener);
  }

  void _scrollListener() {
    final visible = _scrollController.position.userScrollDirection != ScrollDirection.reverse;
    if (widget.onFabVisibilityChanged != null) {
      widget.onFabVisibilityChanged!(visible);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Row(
            children: [
              Expanded(child: Text('Orders', style: Theme.of(context).textTheme.titleLarge)),
              Text('Actions', style: Theme.of(context).textTheme.titleLarge),
            ],
          ),
        ),
        Expanded(
          child: StreamBuilder<List<Order>>(
            stream: _controller.getOrdersByStatus('reviewing'),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(child: CircularProgressIndicator());
              }
              if (snapshot.hasError) {
                return Center(child: Text('Error: ${snapshot.error}'));
              }
              if (!snapshot.hasData || snapshot.data!.isEmpty) {
                return const Center(child: Text('No orders found.'));
              }
              final orders = snapshot.data!;
              return ListView.builder(
                controller: _scrollController,
                itemCount: orders.length,
                itemBuilder: (context, index) {
                  final order = orders[index];
                  return Container(
                    margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [Colors.red[50]!, Colors.orange[50]!],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(order.orderId.toString(), style: const TextStyle(fontWeight: FontWeight.bold)),
                                Text(order.name),
                                Text('Dine-in'),
                              ],
                            ),
                          ),
                          IconButton(
                            icon: const Icon(Icons.visibility, color: Colors.blue),
                            onPressed: () => Toast.show(context, 'View Order'),
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            },
          ),
        ),
      ],
    );
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }
}// END OF FILE for pages\cashier\order_tab_page.dart


// pages\cashier\payment_page.dart
// pages/cashier/payment_page.dart
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/controllers/general/payment_controller.dart';
import 'package:bbqlagao_and_beefpares/models/payment.dart';
import 'package:bbqlagao_and_beefpares/models/order.dart';

class PaymentPage extends StatefulWidget {
  final Order order;
  final double totalAmount;

  const PaymentPage({super.key, required this.order, required this.totalAmount});

  @override
  State<PaymentPage> createState() => _PaymentPageState();
}

class _PaymentPageState extends State<PaymentPage> {
  final PaymentController _paymentController = PaymentController();
  final _formKey = GlobalKey<FormState>();
  String _paymentType = 'Cash';
  String _provider = 'GCash';
  final _nameCtrl = TextEditingController(text: 'Customer');
  final _amountCtrl = TextEditingController();
  final _mobileCtrl = TextEditingController();
  final _refCtrl = TextEditingController();

  @override
  void initState() {
    super.initState();
    _amountCtrl.text = widget.totalAmount.toStringAsFixed(2);
  }

  @override
  Widget build(BuildContext context) {
    final isCash = _paymentType == 'Cash';
    return Scaffold(
      appBar: AppBar(
        title: const Text('Payment'),
        backgroundColor: Colors.redAccent,
      ),
      body: Form(
        key: _formKey,
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(16.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Payment Type'),
              DropdownButtonFormField<String>(
                value: _paymentType,
                items: ['Cash', 'E-Payment'].map((t) => DropdownMenuItem(value: t, child: Text(t))).toList(),
                onChanged: (value) {
                  setState(() {
                    _paymentType = value!;
                  });
                },
              ),
              const SizedBox(height: 16),
              if (isCash) ...[
                const Text('Name'),
                TextFormField(
                  controller: _nameCtrl,
                  decoration: const InputDecoration(),
                  validator: (value) => value!.isEmpty ? 'Name is required' : null,
                ),
                const Text('Amount'),
                TextFormField(
                  controller: _amountCtrl,
                  enabled: false,
                  decoration: const InputDecoration(),
                  validator: (value) => double.tryParse(value!) == null ? 'Invalid amount' : null,
                ),
              ] else ...[
                const Text('Payment Provider'),
                DropdownButtonFormField<String>(
                  value: _provider,
                  items: ['GCash'].map((p) => DropdownMenuItem(value: p, child: Text(p))).toList(),
                  onChanged: (value) => setState(() => _provider = value!),
                ),
                const Text('Mobile Number'),
                TextFormField(
                  controller: _mobileCtrl,
                  keyboardType: TextInputType.phone,
                  decoration: const InputDecoration(),
                  validator: (value) => value!.isEmpty ? 'Mobile number is required' : null,
                ),
                const Text('Reference Number'),
                TextFormField(
                  controller: _refCtrl,
                  decoration: const InputDecoration(),
                  validator: (value) => value!.isEmpty ? 'Reference number is required' : null,
                ),
              ],
            ],
          ),
        ),
      ),
      bottomNavigationBar: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.end,
          children: [
            TextButton(
              onPressed: () => Navigator.pop(context, false),
              child: const Text('Back'),
            ),
            const SizedBox(width: 8),
            ElevatedButton(
              onPressed: () async {
                if (_formKey.currentState!.validate()) {
                  final paymentDetails = isCash
                      ? {'name': _nameCtrl.text, 'amount': double.parse(_amountCtrl.text)}
                      : {'provider': _provider, 'mobileNumber': _mobileCtrl.text, 'referenceNumber': _refCtrl.text};
                  final payment = Payment(
                    orderId: widget.order.orderId,
                    paymentMethod: _paymentType,
                    paymentDetails: paymentDetails,
                  );
                  await _paymentController.addPayment(payment);
                  if (mounted) Navigator.pop(context, true);
                }
              },
              style: ElevatedButton.styleFrom(backgroundColor: Colors.orangeAccent),
              child: const Text('Add Order', style: TextStyle(color: Colors.white)),
            ),
          ],
        ),
      ),
    );
  }

  @override
  void dispose() {
    _nameCtrl.dispose();
    _amountCtrl.dispose();
    _mobileCtrl.dispose();
    _refCtrl.dispose();
    super.dispose();
  }
}// END OF FILE for pages\cashier\payment_page.dart


// pages\cashier\preparing_tab_page.dart
// pages/cashier/preparing_tab_page.dart
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/controllers/general/order_controller.dart';
import 'package:bbqlagao_and_beefpares/models/order.dart';
import 'package:bbqlagao_and_beefpares/customtoast.dart';

class PreparingTabPage extends StatelessWidget {
  const PreparingTabPage({super.key});

  @override
  Widget build(BuildContext context) {
    final OrderController _controller = OrderController();
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Row(
            children: [
              Expanded(child: Text('Preparing', style: Theme.of(context).textTheme.titleLarge)),
              Text('Actions', style: Theme.of(context).textTheme.titleLarge),
            ],
          ),
        ),
        Expanded(
          child: StreamBuilder<List<Order>>(
            stream: _controller.getOrdersByStatus('preparing'),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(child: CircularProgressIndicator());
              }
              if (snapshot.hasError) {
                return Center(child: Text('Error: ${snapshot.error}'));
              }
              if (!snapshot.hasData || snapshot.data!.isEmpty) {
                return const Center(child: Text('No preparing orders found.'));
              }
              final orders = snapshot.data!;
              return ListView.builder(
                itemCount: orders.length,
                itemBuilder: (context, index) {
                  final order = orders[index];
                  return Container(
                    margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [Colors.red[50]!, Colors.orange[50]!],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(order.orderId.toString(), style: const TextStyle(fontWeight: FontWeight.bold)),
                                Text(order.name),
                                Text('Dine-in'),
                              ],
                            ),
                          ),
                          IconButton(
                            icon: const Icon(Icons.visibility, color: Colors.blue),
                            onPressed: () => Toast.show(context, 'View Order'),
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            },
          ),
        ),
      ],
    );
  }
}// END OF FILE for pages\cashier\preparing_tab_page.dart


// pages\cashier\serving_tab_page.dart
// pages/cashier/serving_tab_page.dart
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/controllers/general/order_controller.dart';
import 'package:bbqlagao_and_beefpares/models/order.dart';
import 'package:bbqlagao_and_beefpares/customtoast.dart';

class ServingTabPage extends StatelessWidget {
  const ServingTabPage({super.key});

  @override
  Widget build(BuildContext context) {
    final OrderController _controller = OrderController();
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Row(
            children: [
              Expanded(
                child: Text(
                  'Serving',
                  style: Theme.of(context).textTheme.titleLarge,
                ),
              ),
              Text('Actions', style: Theme.of(context).textTheme.titleLarge),
            ],
          ),
        ),
        Expanded(
          child: StreamBuilder<List<Order>>(
            stream: _controller.getOrdersByStatus('serving'),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(child: CircularProgressIndicator());
              }
              if (snapshot.hasError) {
                return Center(child: Text('Error: ${snapshot.error}'));
              }
              if (!snapshot.hasData || snapshot.data!.isEmpty) {
                return const Center(child: Text('No serving orders found.'));
              }
              final orders = snapshot.data!;
              return ListView.builder(
                itemCount: orders.length,
                itemBuilder: (context, index) {
                  final order = orders[index];
                  return Container(
                    margin: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [Colors.red[50]!, Colors.orange[50]!],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  order.orderId.toString(),
                                  style: const TextStyle(
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                Text(order.name),
                                Text('Dine-in'),
                              ],
                            ),
                          ),
                          IconButton(
                            icon: const Icon(
                              Icons.visibility,
                              color: Colors.blue,
                            ),
                            onPressed: () => Toast.show(context, 'View Order'),
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            },
          ),
        ),
      ],
    );
  }
}
// END OF FILE for pages\cashier\serving_tab_page.dart


// pages\manager\inventory_page.dart
import 'package:bbqlagao_and_beefpares/customtoast.dart';
import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/inventory_controller.dart';
import 'package:bbqlagao_and_beefpares/models/item.dart';
import 'modify_item_page.dart';

class InventoryPage extends StatefulWidget {
  final Function(bool)? onFabVisibilityChanged;

  const InventoryPage({super.key, this.onFabVisibilityChanged});

  @override
  State<InventoryPage> createState() => _InventoryPageState();
}

class _InventoryPageState extends State<InventoryPage> {
  final ScrollController _scrollController = ScrollController();
  final InventoryController _controller = InventoryController();

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_scrollListener);
  }

  void _scrollListener() {
    final visible =
        _scrollController.position.userScrollDirection !=
        ScrollDirection.reverse;
    if (widget.onFabVisibilityChanged != null) {
      widget.onFabVisibilityChanged!(visible);
    }
  }

  void _showDeleteDialog(Item item) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: const Text('Confirm Delete'),
          content: Text('Are you sure you want to delete ${item.name}?'),
          actions: <Widget>[
            TextButton(
              child: const Text('Cancel'),
              onPressed: () {
                Navigator.of(context).pop();
              },
            ),
            TextButton(
              child: const Text('Delete'),
              onPressed: () async {
                await _controller.deleteItem(item.id!);
                if (context.mounted) {
                  Navigator.of(context).pop();
                }
              },
            ),
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Row(
            children: [
              Expanded(
                child: Text(
                  'Item Name',
                  style: Theme.of(context).textTheme.titleLarge,
                ),
              ),
              Text('Actions', style: Theme.of(context).textTheme.titleLarge),
            ],
          ),
        ),
        Expanded(
          child: StreamBuilder<List<Item>>(
            stream: _controller.getItems,
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(child: CircularProgressIndicator());
              }
              if (snapshot.hasError) {
                return Center(child: Text('Error: ${snapshot.error}'));
              }
              if (!snapshot.hasData || snapshot.data!.isEmpty) {
                return const Center(child: Text('No inventory items found.'));
              }
              final items = snapshot.data!;
              return ListView.builder(
                controller: _scrollController,
                itemCount: items.length,
                itemBuilder: (context, index) {
                  final item = items[index];
                  return Container(
                    margin: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [Colors.red[50]!, Colors.orange[50]!],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          SizedBox(
                            width: 60,
                            height: 60,
                            child: item.imageUrl != null
                                ? ClipRRect(
                                    borderRadius: BorderRadius.circular(8),
                                    child: Image.network(
                                      item.imageUrl!,
                                      fit: BoxFit.cover,
                                      errorBuilder:
                                          (context, error, stackTrace) =>
                                              const Icon(
                                                Icons.image_not_supported,
                                                size: 60,
                                              ),
                                    ),
                                  )
                                : const Icon(
                                    Icons.image_not_supported,
                                    size: 60,
                                  ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  item.name,
                                  style: const TextStyle(
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  'Quantity: ${item.quantity}',
                                  style: TextStyle(
                                    fontSize: 12,
                                    color: Colors.grey[600],
                                  ),
                                ),
                              ],
                            ),
                          ),
                          Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              IconButton(
                                icon: Icon(Icons.edit, color: Colors.blue),
                                onPressed: () {
                                  Navigator.push(
                                    context,
                                    MaterialPageRoute(
                                      builder: (context) => ModifyItemPage(
                                        itemId: item.id,
                                        item: item,
                                      ),
                                    ),
                                  );
                                },
                                onLongPress: () =>
                                    Toast.show(context, "Edit Item"),
                              ),
                              IconButton(
                                icon: Icon(Icons.delete, color: Colors.red),
                                onPressed: () => _showDeleteDialog(item),
                                onLongPress: () =>
                                    Toast.show(context, "Delete Item"),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            },
          ),
        ),
      ],
    );
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }
}
// END OF FILE for pages\manager\inventory_page.dart


// pages\manager\menu_page.dart
import 'package:bbqlagao_and_beefpares/customtoast.dart';
import 'package:flutter/material.dart' hide MenuController;
import 'package:flutter/rendering.dart';
import '../../controllers/manager/menu_controller.dart';
import '../../models/dish.dart';
import 'modify_dish_page.dart';

class MenuPage extends StatefulWidget {
  final Function(bool)? onFabVisibilityChanged;

  const MenuPage({super.key, this.onFabVisibilityChanged});

  @override
  State<MenuPage> createState() => _MenuPageState();
}

class _MenuPageState extends State<MenuPage> {
  final ScrollController _scrollController = ScrollController();
  final MenuController _controller = MenuController();

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_scrollListener);
  }

  void _scrollListener() {
    final visible =
        _scrollController.position.userScrollDirection !=
        ScrollDirection.reverse;
    if (widget.onFabVisibilityChanged != null) {
      widget.onFabVisibilityChanged!(visible);
    }
  }

  void _showDeleteDialog(Dish dish) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: const Text('Confirm Delete'),
          content: Text('Are you sure you want to delete ${dish.name}?'),
          actions: <Widget>[
            TextButton(
              child: const Text('Cancel'),
              onPressed: () {
                Navigator.of(context).pop();
              },
            ),
            TextButton(
              child: const Text('Delete'),
              onPressed: () async {
                await _controller.deleteDish(dish.id!);
                if (context.mounted) {
                  Navigator.of(context).pop();
                }
              },
            ),
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Row(
            children: [
              Expanded(
                child: Text(
                  'Dish Name',
                  style: Theme.of(context).textTheme.titleLarge,
                ),
              ),
              Text('Actions', style: Theme.of(context).textTheme.titleLarge),
            ],
          ),
        ),
        Expanded(
          child: StreamBuilder<List<Dish>>(
            stream: _controller.getDishes,
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(child: CircularProgressIndicator());
              }
              if (snapshot.hasError) {
                return Center(child: Text('Error: ${snapshot.error}'));
              }
              if (!snapshot.hasData || snapshot.data!.isEmpty) {
                return const Center(child: Text('No menu items found.'));
              }
              final dishes = snapshot.data!;
              return ListView.builder(
                controller: _scrollController,
                itemCount: dishes.length,
                itemBuilder: (context, index) {
                  final dish = dishes[index];
                  return Container(
                    margin: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [Colors.red[50]!, Colors.orange[50]!],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          SizedBox(
                            width: 60,
                            height: 60,
                            child: dish.imageUrl != null
                                ? ClipRRect(
                                    borderRadius: BorderRadius.circular(8),
                                    child: Image.network(
                                      dish.imageUrl!,
                                      fit: BoxFit.cover,
                                      errorBuilder:
                                          (context, error, stackTrace) =>
                                              const Icon(
                                                Icons.image_not_supported,
                                                size: 60,
                                              ),
                                    ),
                                  )
                                : const Icon(
                                    Icons.image_not_supported,
                                    size: 60,
                                  ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  dish.name,
                                  style: const TextStyle(
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                Text(
                                  'â‚±${dish.price.toStringAsFixed(2)}',
                                  style: const TextStyle(fontSize: 16),
                                ),
                                Text(
                                  'Visible: ${dish.isVisible ? 'True' : 'False'}',
                                ),
                                Text(
                                  'Available: ${dish.isAvailable ? 'True' : 'False'}',
                                ),
                              ],
                            ),
                          ),
                          Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              IconButton(
                                icon: const Icon(
                                  Icons.edit,
                                  color: Colors.blue,
                                ),
                                onPressed: () {
                                  Navigator.push(
                                    context,
                                    MaterialPageRoute(
                                      builder: (context) => ModifyDishPage(
                                        dishId: dish.id,
                                        dish: dish,
                                      ),
                                    ),
                                  );
                                },
                                onLongPress: () =>
                                    Toast.show(context, "Edit Menu"),
                              ),
                              IconButton(
                                icon: const Icon(
                                  Icons.delete,
                                  color: Colors.red,
                                ),
                                onPressed: () => _showDeleteDialog(dish),
                                onLongPress: () =>
                                    Toast.show(context, "Delete Menu"),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            },
          ),
        ),
      ],
    );
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }
}
// END OF FILE for pages\manager\menu_page.dart


// pages\manager\modify_dish_page.dart
import 'package:bbqlagao_and_beefpares/controllers/manager/inventory_controller.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/menu_controller.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/material.dart' hide MenuController;
import 'package:bbqlagao_and_beefpares/customtoast.dart';
import '../../models/dish.dart';
import '../../models/item.dart';

class ModifyDishPage extends StatefulWidget {
  final String? dishId;
  final Dish? dish;

  const ModifyDishPage({super.key, this.dishId, this.dish});

  @override
  State<ModifyDishPage> createState() => _ModifyDishPageState();
}

class _ModifyDishPageState extends State<ModifyDishPage> {
  final _formKey = GlobalKey<FormState>();
  late TextEditingController _nameCtrl;
  late TextEditingController _descCtrl;
  late TextEditingController _priceCtrl;
  late TextEditingController _imageUrlCtrl;
  late bool _isVisible;
  final MenuController _menuController = MenuController();
  final InventoryController _inventoryController = InventoryController();
  List<Map<String, dynamic>> _selectedIngredients = [];
  double _price = 0.0;

  @override
  void initState() {
    super.initState();
    _nameCtrl = TextEditingController(text: widget.dish?.name ?? '');
    _descCtrl = TextEditingController(text: widget.dish?.description ?? '');
    _priceCtrl = TextEditingController(
      text: widget.dish?.price.toStringAsFixed(2) ?? '0.00',
    );
    _imageUrlCtrl = TextEditingController(text: widget.dish?.imageUrl ?? '');
    _isVisible = widget.dish?.isVisible ?? true;
    _price = widget.dish?.price ?? 0.0;
    if (widget.dish != null) {
      _selectedIngredients = List<Map<String, dynamic>>.from(
        widget.dish!.ingredients
            .where((ing) => ing['itemId'] != null)
            .map((ing) => {'id': ing['itemId'], 'quantity': ing['quantity']}),
      );
      _loadIngredientNames();
    }
  }

  Future<void> _loadIngredientNames() async {
    final List<Map<String, dynamic>> updated = [];
    for (final ing in _selectedIngredients) {
      if (ing['id'] == null) continue;
      final doc = await FirebaseFirestore.instance
          .collection('inventory')
          .doc(ing['id'])
          .get();
      if (doc.exists) {
        final data = doc.data()!;
        updated.add({
          'id': ing['id'],
          'name': data['name'] ?? 'Unknown',
          'quantity': ing['quantity'],
        });
      } else {
        if (mounted) {
          Toast.show(context, 'Item Unavailable/Deleted');
        }
      }
    }
    if (mounted) {
      setState(() {
        _selectedIngredients = updated;
      });
    }
  }

  void _incrementPrice() {
    setState(() {
      _price += 0.01;
      _priceCtrl.text = _price.toStringAsFixed(2);
    });
  }

  void _decrementPrice() {
    if (_price > 0) {
      setState(() {
        _price -= 0.01;
        _priceCtrl.text = _price.toStringAsFixed(2);
      });
    }
  }

  void _addIngredient() {
    showDialog(
      context: context,
      builder: (context) => _IngredientSelectionDialog(
        inventoryController: _inventoryController,
        selectedIngredients: _selectedIngredients,
        onSelected: (id, name, quantity) {
          setState(() {
            _selectedIngredients.add({
              'id': id,
              'name': name,
              'quantity': quantity,
            });
          });
        },
      ),
    );
  }

  void _updateIngredientQuantity(String id, int newQuantity) {
    setState(() {
      final index = _selectedIngredients.indexWhere((ing) => ing['id'] == id);
      if (index != -1 && newQuantity >= 0) {
        _selectedIngredients[index]['quantity'] = newQuantity;
      }
    });
  }

  void _removeIngredient(String id) {
    setState(() {
      _selectedIngredients.removeWhere((ing) => ing['id'] == id);
    });
  }

  Future<bool> _computeAvailability() async {
    for (final ing in _selectedIngredients) {
      if (ing['id'] == null) return false;
      final doc = await FirebaseFirestore.instance
          .collection('inventory')
          .doc(ing['id'])
          .get();
      if (!doc.exists || (doc.data()?['quantity'] ?? 0) < ing['quantity']) {
        return false;
      }
    }
    return true;
  }

  Widget _buildImagePreview() {
    if (_imageUrlCtrl.text.isEmpty) return const SizedBox.shrink();
    return Padding(
      padding: const EdgeInsets.all(16.0),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(8),
        child: Image.network(
          _imageUrlCtrl.text,
          height: 200,
          fit: BoxFit.cover,
          errorBuilder: (context, error, stackTrace) => const Icon(Icons.error),
        ),
      ),
    );
  }

  Widget _buildIngredientsList() {
    return SizedBox(
      height: 200,
      child: SingleChildScrollView(
        child: ListView.builder(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          itemCount: _selectedIngredients.length,
          itemBuilder: (context, index) {
            final ing = _selectedIngredients[index];
            return Card(
              child: ListTile(
                title: Text(ing['name'] ?? 'Unknown'),
                subtitle: Text('Quantity: ${ing['quantity']}'),
                trailing: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    IconButton(
                      icon: const Icon(Icons.remove),
                      onPressed: () => _updateIngredientQuantity(
                        ing['id'],
                        (ing['quantity'] as int) - 1,
                      ),
                    ),
                    Text('${ing['quantity']}'),
                    IconButton(
                      icon: const Icon(Icons.add),
                      onPressed: () => _updateIngredientQuantity(
                        ing['id'],
                        (ing['quantity'] as int) + 1,
                      ),
                    ),
                    IconButton(
                      icon: const Icon(Icons.delete),
                      onPressed: () => _removeIngredient(ing['id']),
                    ),
                  ],
                ),
              ),
            );
          },
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final title = widget.dishId != null ? 'Edit Dish' : 'New Dish';
    final buttonText = widget.dishId != null ? 'Update Dish' : 'Add Dish';
    return Scaffold(
      resizeToAvoidBottomInset: false,
      appBar: AppBar(title: Text(title)),
      body: Stack(
        children: [
          SingleChildScrollView(
            child: Padding(
              padding: const EdgeInsets.all(16.0).copyWith(bottom: 80.0),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text('Dish Name'),
                    TextFormField(
                      controller: _nameCtrl,
                      decoration: const InputDecoration(),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Dish name is required';
                        }
                        return null;
                      },
                    ),
                    const Divider(),
                    const Text('Description'),
                    TextFormField(
                      controller: _descCtrl,
                      decoration: const InputDecoration(),
                      maxLines: 3,
                    ),
                    const Divider(),
                    const Text('Price'),
                    Row(
                      children: [
                        IconButton(
                          icon: const Icon(Icons.remove),
                          onPressed: _decrementPrice,
                        ),
                        Expanded(
                          child: TextFormField(
                            controller: _priceCtrl,
                            decoration: const InputDecoration(),
                            keyboardType: const TextInputType.numberWithOptions(
                              decimal: true,
                            ),
                            validator: (value) {
                              if (value == null ||
                                  double.tryParse(value) == null) {
                                return 'Please enter a valid price';
                              }
                              return null;
                            },
                          ),
                        ),
                        IconButton(
                          icon: const Icon(Icons.add),
                          onPressed: _incrementPrice,
                        ),
                      ],
                    ),
                    const Divider(),
                    Row(
                      children: [
                        const Text('Publish Dish'),
                        const Spacer(),
                        Switch(
                          value: _isVisible,
                          onChanged: (value) =>
                              setState(() => _isVisible = value),
                          activeThumbColor: Colors.amber,
                        ),
                      ],
                    ),
                    const Divider(),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton(
                        onPressed: _addIngredient,
                        child: Text(
                          'Add Ingredient',
                          style: TextStyle(color: Colors.amber[300]),
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    const Text('Selected Ingredients:'),
                    _buildIngredientsList(),
                    const Divider(),
                    const Text('Image URL'),
                    TextFormField(
                      controller: _imageUrlCtrl,
                      decoration: const InputDecoration(),
                    ),
                    _buildImagePreview(),
                    const SizedBox(height: 20),
                  ],
                ),
              ),
            ),
          ),
          Align(
            alignment: Alignment.bottomRight,
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  OutlinedButton(
                    style: OutlinedButton.styleFrom(
                      side: const BorderSide(color: Colors.redAccent),
                      foregroundColor: Colors.redAccent,
                      backgroundColor: Colors.white,
                    ),
                    onPressed: () => Navigator.pop(context),
                    child: const Text('Cancel'),
                  ),
                  const SizedBox(width: 8),
                  ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.orangeAccent,
                    ),
                    onPressed: () async {
                      if (_formKey.currentState!.validate()) {
                        final bool available = await _computeAvailability();
                        final ingredientsForSave = _selectedIngredients
                            .where((ing) => ing['id'] != null)
                            .map(
                              (ing) => {
                                'itemId': ing['id'],
                                'quantity': ing['quantity'],
                              },
                            )
                            .toList();
                        final newDish = Dish(
                          id: widget.dishId,
                          name: _nameCtrl.text,
                          description: _descCtrl.text.isEmpty
                              ? null
                              : _descCtrl.text,
                          price: double.parse(_priceCtrl.text),
                          isVisible: _isVisible,
                          isAvailable: available,
                          ingredients: ingredientsForSave,
                          imageUrl: _imageUrlCtrl.text.isEmpty
                              ? null
                              : _imageUrlCtrl.text,
                        );
                        if (widget.dishId == null) {
                          await _menuController.addDish(newDish);
                        } else {
                          await _menuController.updateDish(
                            widget.dishId!,
                            newDish,
                          );
                        }
                        if (context.mounted) {
                          Navigator.pop(context);
                        }
                      }
                    },
                    child: Text(
                      buttonText,
                      style: const TextStyle(color: Colors.white),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _nameCtrl.dispose();
    _descCtrl.dispose();
    _priceCtrl.dispose();
    _imageUrlCtrl.dispose();
    super.dispose();
  }
}

class _IngredientSelectionDialog extends StatefulWidget {
  final InventoryController inventoryController;
  final List<Map<String, dynamic>>? selectedIngredients;
  final Function(String, String, int) onSelected;

  const _IngredientSelectionDialog({
    required this.inventoryController,
    this.selectedIngredients,
    required this.onSelected,
  });

  @override
  State<_IngredientSelectionDialog> createState() =>
      _IngredientSelectionDialogState();
}

class _IngredientSelectionDialogState
    extends State<_IngredientSelectionDialog> {
  final _quantityController = TextEditingController(text: '1');
  final _searchController = TextEditingController();
  Item? _selectedItem;
  String _searchText = '';

  @override
  void initState() {
    super.initState();
    _searchController.addListener(() {
      setState(() {
        _searchText = _searchController.text.toLowerCase();
      });
    });
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('Select Ingredient'),
      content: SizedBox(
        width: double.maxFinite,
        height: 300,
        child: Column(
          children: [
            TextField(
              controller: _searchController,
              decoration: const InputDecoration(
                labelText: 'Search Ingredients',
                prefixIcon: Icon(Icons.search),
              ),
            ),
            const SizedBox(height: 8),
            Expanded(
              child: StreamBuilder<List<Item>>(
                stream: widget.inventoryController.getItems,
                builder: (context, snapshot) {
                  if (snapshot.hasData) {
                    final items = snapshot.data!
                        .where(
                          (item) =>
                              item.name.toLowerCase().contains(_searchText),
                        )
                        .toList();
                    return ListView.builder(
                      itemCount: items.length,
                      itemBuilder: (context, index) {
                        final item = items[index];
                        final alreadyAdded =
                            widget.selectedIngredients?.any(
                              (ing) => ing['id'] == item.id,
                            ) ??
                            false;
                        return ListTile(
                          title: Text(item.name),
                          enabled: !alreadyAdded,
                          onTap: alreadyAdded
                              ? null
                              : () => setState(() => _selectedItem = item),
                          selected: _selectedItem?.id == item.id,
                          selectedColor: Colors.orange,
                        );
                      },
                    );
                  }
                  return const CircularProgressIndicator();
                },
              ),
            ),
            TextField(
              controller: _quantityController,
              decoration: const InputDecoration(labelText: 'Quantity'),
              keyboardType: TextInputType.number,
            ),
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text('Cancel', style: TextStyle(color: Colors.orange)),
        ),
        ElevatedButton(
          onPressed: _selectedItem != null
              ? () {
                  final qty = int.tryParse(_quantityController.text) ?? 1;
                  widget.onSelected(
                    _selectedItem!.id!,
                    _selectedItem!.name,
                    qty,
                  );
                  Navigator.pop(context);
                }
              : null,
          child: Text('Add', style: TextStyle(color: Colors.orange)),
        ),
      ],
    );
  }

  @override
  void dispose() {
    _quantityController.dispose();
    _searchController.dispose();
    super.dispose();
  }
}
// END OF FILE for pages\manager\modify_dish_page.dart


// pages\manager\modify_item_page.dart
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/inventory_controller.dart';
import 'package:bbqlagao_and_beefpares/models/item.dart';

class ModifyItemPage extends StatefulWidget {
  final String? itemId;
  final Item? item;

  const ModifyItemPage({super.key, this.itemId, this.item});

  @override
  State<ModifyItemPage> createState() => _ModifyItemPageState();
}

class _ModifyItemPageState extends State<ModifyItemPage> {
  final _formKey = GlobalKey<FormState>();
  late TextEditingController _nameCtrl;
  late TextEditingController _descCtrl;
  late TextEditingController _qtyCtrl;
  late TextEditingController _imageUrlCtrl;
  int _quantity = 0;
  final InventoryController _controller = InventoryController();

  @override
  void initState() {
    super.initState();
    _nameCtrl = TextEditingController(text: widget.item?.name ?? '');
    _descCtrl = TextEditingController(text: widget.item?.description ?? '');
    _qtyCtrl = TextEditingController(text: '${widget.item?.quantity ?? 0}');
    _imageUrlCtrl = TextEditingController(text: widget.item?.imageUrl ?? '');
    _quantity = widget.item?.quantity ?? 0;
  }

  void _incrementQty() {
    setState(() {
      _quantity++;
      _qtyCtrl.text = _quantity.toString();
    });
  }

  void _decrementQty() {
    if (_quantity > 0) {
      setState(() {
        _quantity--;
        _qtyCtrl.text = _quantity.toString();
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final title = widget.itemId != null ? 'Edit Item' : 'New Item';
    final buttonText = widget.itemId != null ? 'Update Item' : 'Add Item';
    return Scaffold(
      resizeToAvoidBottomInset: false,
      appBar: AppBar(title: Text(title)),
      body: Stack(
        children: [
          SingleChildScrollView(
            child: Padding(
              padding: const EdgeInsets.all(16.0).copyWith(bottom: 80.0),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text('Item Name'),
                    TextFormField(
                      controller: _nameCtrl,
                      decoration: const InputDecoration(),
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'Item name is required';
                        }
                        return null;
                      },
                    ),
                    const Divider(),
                    const Text('Description'),
                    TextFormField(
                      controller: _descCtrl,
                      decoration: const InputDecoration(),
                      maxLines: 5,
                    ),
                    const Divider(),
                    const Text('Quantity'),
                    Row(
                      children: [
                        IconButton(
                          icon: const Icon(Icons.remove),
                          onPressed: _decrementQty,
                        ),
                        Expanded(
                          child: TextFormField(
                            controller: _qtyCtrl,
                            decoration: const InputDecoration(),
                            keyboardType: TextInputType.number,
                            validator: (value) {
                              if (value == null ||
                                  int.tryParse(value) == null) {
                                return 'Please enter a valid number';
                              }
                              return null;
                            },
                          ),
                        ),
                        IconButton(
                          icon: const Icon(Icons.add),
                          onPressed: _incrementQty,
                        ),
                      ],
                    ),
                    const Divider(),
                    const Text('Image URL'),
                    TextFormField(
                      controller: _imageUrlCtrl,
                      decoration: const InputDecoration(),
                    ),
                    const SizedBox(height: 20),
                  ],
                ),
              ),
            ),
          ),
          Align(
            alignment: Alignment.bottomRight,
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  OutlinedButton(
                    style: OutlinedButton.styleFrom(
                      side: const BorderSide(color: Colors.redAccent),
                      foregroundColor: Colors.redAccent,
                    ),
                    onPressed: () => Navigator.pop(context),
                    child: const Text('Cancel'),
                  ),
                  const SizedBox(width: 8),
                  ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.orangeAccent,
                    ),
                    onPressed: () async {
                      if (_formKey.currentState!.validate()) {
                        final newItem = Item(
                          id: widget.itemId ?? '',
                          name: _nameCtrl.text,
                          description: _descCtrl.text.isEmpty
                              ? null
                              : _descCtrl.text,
                          quantity: int.parse(_qtyCtrl.text),
                          imageUrl: _imageUrlCtrl.text.isEmpty
                              ? null
                              : _imageUrlCtrl.text,
                        );
                        if (widget.itemId == null) {
                          await _controller.addItem(newItem);
                        } else {
                          await _controller.updateItem(widget.itemId!, newItem);
                        }
                        if (context.mounted) {
                          Navigator.pop(context);
                        }
                      }
                    },
                    child: Text(
                      buttonText,
                      style: const TextStyle(color: Colors.white),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _nameCtrl.dispose();
    _descCtrl.dispose();
    _qtyCtrl.dispose();
    _imageUrlCtrl.dispose();
    super.dispose();
  }
}
// END OF FILE for pages\manager\modify_item_page.dart


// pages\manager\modify_user_page.dart
import 'package:firebase_auth/firebase_auth.dart' as auth;
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/users_controller.dart';
import 'package:bbqlagao_and_beefpares/models/user.dart';

class ModifyUserPage extends StatefulWidget {
  final String? userId;
  final User? user;

  const ModifyUserPage({super.key, this.userId, this.user});

  @override
  State<ModifyUserPage> createState() => _ModifyUserPageState();
}

class _ModifyUserPageState extends State<ModifyUserPage> {
  final _formKey = GlobalKey<FormState>();
  late TextEditingController _nameCtrl;
  late TextEditingController _emailCtrl;
  late TextEditingController _passwordCtrl;
  late TextEditingController _confirmPasswordCtrl;
  String _role = 'Cashier';
  final UsersController _controller = UsersController();
  bool get isEdit => widget.userId != null;

  @override
  void initState() {
    super.initState();
    _nameCtrl = TextEditingController(text: widget.user?.name ?? '');
    _emailCtrl = TextEditingController(text: widget.user?.email ?? '');
    _passwordCtrl = TextEditingController();
    _confirmPasswordCtrl = TextEditingController();
    _role = widget.user?.role ?? 'Cashier';
  }

  @override
  Widget build(BuildContext context) {
    final title = isEdit ? 'Edit Staff' : 'New Staff';
    final buttonText = isEdit ? 'Update Staff' : 'Add Staff';
    return Scaffold(
      resizeToAvoidBottomInset: false,
      appBar: AppBar(title: Text(title)),
      body: Stack(
        children: [
          SingleChildScrollView(
            child: Padding(
              padding: const EdgeInsets.all(16.0).copyWith(bottom: 80.0),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text('Name'),
                    TextFormField(
                      controller: _nameCtrl,
                      validator: (value) =>
                          value!.isEmpty ? 'Name is required' : null,
                    ),
                    const Divider(),
                    if (!isEdit) ...[
                      const Text('Email'),
                      TextFormField(
                        controller: _emailCtrl,
                        keyboardType: TextInputType.emailAddress,
                        validator: (value) =>
                            value!.isEmpty ? 'Email is required' : null,
                      ),
                      const Divider(),
                    ],
                    const Text('Role'),
                    DropdownButtonFormField<String>(
                      initialValue: _role,
                      items: ['Admin', 'Manager', 'Cashier']
                          .map(
                            (r) => DropdownMenuItem(value: r, child: Text(r)),
                          )
                          .toList(),
                      onChanged: (value) => setState(() => _role = value!),
                      validator: (value) =>
                          value == null ? 'Role is required' : null,
                    ),
                    if (!isEdit) ...[
                      const Divider(),
                      const Text('Password'),
                      TextFormField(
                        controller: _passwordCtrl,
                        obscureText: true,
                        validator: (value) =>
                            value!.isEmpty ? 'Password is required' : null,
                      ),
                      const Divider(),
                      const Text('Confirm Password'),
                      TextFormField(
                        controller: _confirmPasswordCtrl,
                        obscureText: true,
                        validator: (value) {
                          if (value!.isEmpty)
                            return 'Confirm Password is required';
                          if (value != _passwordCtrl.text)
                            return 'Passwords do not match';
                          return null;
                        },
                      ),
                      const Divider(),
                    ],
                  ],
                ),
              ),
            ),
          ),
          Align(
            alignment: Alignment.bottomRight,
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  OutlinedButton(
                    style: OutlinedButton.styleFrom(
                      side: const BorderSide(color: Colors.redAccent),
                      foregroundColor: Colors.redAccent,
                      backgroundColor: Colors.white,
                    ),
                    onPressed: () => Navigator.pop(context),
                    child: const Text('Cancel'),
                  ),
                  const SizedBox(width: 8),
                  ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.orangeAccent,
                    ),
                    onPressed: () async {
                      if (_formKey.currentState!.validate()) {
                        final newUser = User(
                          id: widget.userId,
                          name: _nameCtrl.text,
                          email: _emailCtrl.text,
                          role: _role,
                          provider: isEdit ? widget.user?.provider : null,
                        );
                        if (isEdit) {
                          await _controller.updateUser(
                            context,
                            widget.userId!,
                            newUser,
                          );
                        } else {
                          await _controller.addUser(
                            context,
                            newUser,
                            _passwordCtrl.text,
                          );
                        }
                        if (context.mounted) Navigator.pop(context);
                      }
                    },
                    child: Text(
                      buttonText,
                      style: const TextStyle(color: Colors.white),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _nameCtrl.dispose();
    _emailCtrl.dispose();
    _passwordCtrl.dispose();
    _confirmPasswordCtrl.dispose();
    super.dispose();
  }
}
// END OF FILE for pages\manager\modify_user_page.dart


// pages\manager\staff_home_page.dart
// pages\manager\staff_home_page.dart
import 'package:flutter/material.dart';
import 'package:bbqlagao_and_beefpares/pages/manager/inventory_page.dart';
import 'package:bbqlagao_and_beefpares/pages/manager/menu_page.dart';
import 'package:bbqlagao_and_beefpares/pages/manager/staff_list_page.dart';
import 'package:bbqlagao_and_beefpares/pages/manager/modify_item_page.dart';
import 'package:bbqlagao_and_beefpares/pages/manager/modify_dish_page.dart';
import 'package:bbqlagao_and_beefpares/pages/manager/modify_user_page.dart';

class StaffHomePage extends StatefulWidget {
  const StaffHomePage({super.key});

  @override
  State<StaffHomePage> createState() => _StaffHomePageState();
}

class _StaffHomePageState extends State<StaffHomePage> {
  String _currentPage = 'menu';
  String _appBarTitle = 'Staff Dashboard';
  String _tooltip = 'Add Menu';
  late ValueNotifier<bool> _showFabNotifier;
  bool _isManagementExpanded = true;
  bool _isUserManagementExpanded = true;

  void _onFabVisibilityChanged(bool visible) {
    _showFabNotifier.value = visible;
  }

  @override
  void initState() {
    super.initState();
    _showFabNotifier = ValueNotifier<bool>(true);
  }

  @override
  void dispose() {
    _showFabNotifier.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Column(
          mainAxisAlignment: MainAxisAlignment.start,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            if (_appBarTitle != 'Staff Dashboard')
              Text(
                'Staff Dashboard',
                style: TextStyle(color: Colors.white, fontSize: 10),
              ),
            Text(_appBarTitle, style: TextStyle(color: Colors.white)),
          ],
        ),

        flexibleSpace:
            _currentPage == 'inventory' ||
                _currentPage == 'menu' ||
                _currentPage == 'staffs'
            ? Container(
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [Colors.redAccent, Colors.red, Colors.orangeAccent],
                  ),
                ),
              )
            : null,
        leading: Builder(
          builder: (context) => IconButton(
            icon: const Icon(Icons.menu),
            color: Colors.white,
            onPressed: () => Scaffold.of(context).openDrawer(),
          ),
        ),
      ),
      drawer: Drawer(
        child: Column(
          children: [
            Container(
              height: 75.0,
              width: double.infinity,
              decoration: const BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [Colors.redAccent, Colors.red, Colors.orangeAccent],
                ),
              ),
              child: const Padding(
                padding: EdgeInsets.all(2),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.end,
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    Text(
                      'BBQ Lagao & Beef Pares',
                      style: TextStyle(color: Colors.white, fontSize: 10),
                    ),
                    Text(
                      'Staff Navigation',
                      style: TextStyle(color: Colors.white, fontSize: 20),
                    ),
                  ],
                ),
              ),
            ),
            Expanded(
              child: ListView(
                padding: EdgeInsets.zero,
                children: <Widget>[
                  ExpansionTile(
                    initiallyExpanded: _isManagementExpanded,
                    onExpansionChanged: (expanded) {
                      setState(() {
                        _isManagementExpanded = expanded;
                      });
                    },
                    title: const Text(
                      'Inventory Management',
                      style: TextStyle(color: Colors.redAccent),
                    ),
                    leading: const Icon(
                      Icons.business,
                      color: Colors.redAccent,
                    ),
                    children: <Widget>[
                      ListTile(
                        leading: Icon(
                          Icons.restaurant_menu,
                          color: _currentPage == 'menu'
                              ? Colors.white
                              : Colors.redAccent,
                        ),
                        title: Text(
                          'Menu',
                          style: TextStyle(
                            color: _currentPage == 'menu'
                                ? Colors.white
                                : Colors.redAccent,
                          ),
                        ),
                        selected: _currentPage == 'menu',
                        selectedTileColor: Colors.redAccent.withValues(
                          alpha: 0.75,
                        ),
                        onTap: () {
                          Navigator.pop(context);
                          setState(() {
                            _currentPage = 'menu';
                            _appBarTitle = 'Menu';
                            _tooltip = 'Add Menu';
                          });
                        },
                      ),
                      ListTile(
                        leading: Icon(
                          Icons.inventory,
                          color: _currentPage == 'inventory'
                              ? Colors.white
                              : Colors.redAccent,
                        ),
                        title: Text(
                          'Inventory',
                          style: TextStyle(
                            color: _currentPage == 'inventory'
                                ? Colors.white
                                : Colors.redAccent,
                          ),
                        ),
                        selected: _currentPage == 'inventory',
                        selectedTileColor: Colors.redAccent.withValues(
                          alpha: .75,
                        ),
                        onTap: () {
                          Navigator.pop(context);
                          setState(() {
                            _currentPage = 'inventory';
                            _appBarTitle = 'Inventory';
                            _tooltip = 'Add Item';
                          });
                        },
                      ),
                    ],
                  ),
                  ExpansionTile(
                    initiallyExpanded: _isUserManagementExpanded,
                    onExpansionChanged: (expanded) {
                      setState(() {
                        _isUserManagementExpanded = expanded;
                      });
                    },
                    title: const Text(
                      'User Management',
                      style: TextStyle(color: Colors.redAccent),
                    ),
                    leading: const Icon(Icons.people, color: Colors.redAccent),
                    children: <Widget>[
                      ListTile(
                        leading: Icon(
                          Icons.person,
                          color: _currentPage == 'staffs'
                              ? Colors.white
                              : Colors.redAccent,
                        ),
                        title: Text(
                          'Staffs',
                          style: TextStyle(
                            color: _currentPage == 'staffs'
                                ? Colors.white
                                : Colors.redAccent,
                          ),
                        ),
                        selected: _currentPage == 'staffs',
                        selectedTileColor: Colors.redAccent.withValues(
                          alpha: .75,
                        ),
                        onTap: () {
                          Navigator.pop(context);
                          setState(() {
                            _currentPage = 'staffs';
                            _appBarTitle = 'Staffs';
                            _tooltip = 'Add Staff';
                          });
                        },
                      ),
                    ],
                  ),
                ],
              ),
            ),
            Align(
              alignment: Alignment.bottomRight,
              child: Padding(
                padding: const EdgeInsets.all(16.0),
                child: IconButton(
                  icon: const Icon(Icons.arrow_left),
                  onPressed: () => Navigator.pop(context),
                  tooltip: 'Close menu',
                ),
              ),
            ),
          ],
        ),
      ),
      body: _buildBody(),
      floatingActionButton:
          (_currentPage == 'inventory' ||
              _currentPage == 'menu' ||
              _currentPage == 'staffs')
          ? ValueListenableBuilder<bool>(
              valueListenable: _showFabNotifier,
              builder: (context, showFab, child) {
                if (!showFab) return const SizedBox.shrink();
                return FloatingActionButton(
                  backgroundColor: Colors.redAccent[100],
                  shape: const CircleBorder(),
                  foregroundColor: Colors.white,
                  onPressed: () {
                    if (_currentPage == 'inventory') {
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (context) => const ModifyItemPage(),
                        ),
                      );
                    } else if (_currentPage == 'menu') {
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (context) => const ModifyDishPage(),
                        ),
                      );
                    } else if (_currentPage == 'staffs') {
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (context) => const ModifyUserPage(),
                        ),
                      );
                    }
                  },
                  tooltip: _tooltip,
                  child: const Icon(Icons.add),
                );
              },
            )
          : null,
    );
  }

  Widget _buildBody() {
    switch (_currentPage) {
      case 'menu':
        return MenuPage(onFabVisibilityChanged: _onFabVisibilityChanged);
      case 'inventory':
        return InventoryPage(onFabVisibilityChanged: _onFabVisibilityChanged);
      case 'staffs':
        return StaffListPage(onFabVisibilityChanged: _onFabVisibilityChanged);
      default:
        return const Center(child: Text('Page not implemented'));
    }
  }
}
// END OF FILE for pages\manager\staff_home_page.dart


// pages\manager\staff_list_page.dart
import 'package:bbqlagao_and_beefpares/customtoast.dart';
import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:bbqlagao_and_beefpares/controllers/manager/users_controller.dart';
import 'package:bbqlagao_and_beefpares/models/user.dart';
import 'modify_user_page.dart';

class StaffListPage extends StatefulWidget {
  final void Function(bool)? onFabVisibilityChanged;
  const StaffListPage({super.key, this.onFabVisibilityChanged});

  @override
  State<StaffListPage> createState() => _StaffListPageState();
}

class _StaffListPageState extends State<StaffListPage> {
  final ScrollController _scrollController = ScrollController();
  final UsersController _controller = UsersController();

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_scrollListener);
  }

  void _scrollListener() {
    final visible =
        _scrollController.position.userScrollDirection !=
        ScrollDirection.reverse;
    if (widget.onFabVisibilityChanged != null) {
      widget.onFabVisibilityChanged!(visible);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Row(
            children: [
              Expanded(
                child: Text(
                  'Staffs',
                  style: Theme.of(context).textTheme.titleLarge,
                ),
              ),
              Text('Actions', style: Theme.of(context).textTheme.titleLarge),
            ],
          ),
        ),
        Expanded(
          child: StreamBuilder<List<User>>(
            stream: _controller.getUsers,
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Center(child: CircularProgressIndicator());
              }
              if (snapshot.hasError) {
                return Center(child: Text('Error: ${snapshot.error}'));
              }
              if (!snapshot.hasData || snapshot.data!.isEmpty) {
                return const Center(child: Text('No staff found.'));
              }
              final users = snapshot.data!;
              return ListView.builder(
                controller: _scrollController,
                itemCount: users.length,
                itemBuilder: (context, index) {
                  final user = users[index];
                  return Container(
                    margin: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [Colors.red[50]!, Colors.orange[50]!],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  user.name,
                                  style: const TextStyle(
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                Text(user.email),
                                Text("Role: ${user.role}"),
                                Text("Provider: ${user.provider ?? 'Unknown'}"),
                              ],
                            ),
                          ),
                          IconButton(
                            icon: const Icon(Icons.edit, color: Colors.blue),
                            onPressed: () {
                              Navigator.push(
                                context,
                                MaterialPageRoute(
                                  builder: (context) => ModifyUserPage(
                                    userId: user.id,
                                    user: user,
                                  ),
                                ),
                              );
                            },
                            onLongPress: () =>
                                Toast.show(context, "Edit Staff"),
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            },
          ),
        ),
      ],
    );
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }
}
// END OF FILE for pages\manager\staff_list_page.dart


